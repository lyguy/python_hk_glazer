#!/usr/bin/env python2

import argparse
import sys as _sys
try:
  import json_to_degree as js2deg
except ImportError:
  from .. import json_to_degree as js2deg


class FileExistsError(Exception):
  def __init__(self, message):
    # Call the base class constructor with the parameters it needs
    Exception.__init__(self, message)


def json_to_dat(in_file, output=None, silent=False):
    """Takes in a valid json input and prints, either to the screen
    or to stdout, a valid input.dat file
    Args:   input : the filename of our .json input
            output : filename for output, None results in being put to stdout
            silent : If true, does not warn on file overwrite
    """
    import json

    # Open json config file and load the contents to a dictionary
    with open(in_file) as conf_file:
        try:
            config = json.load(conf_file)
        except ValueError as e:
            print "Json error, " + str(e) + " in {0}".format(conf_file.name)
            return

# Outputs config file (input.dat) to std out or to a file
    if output == None:
        print js2deg.dict_to_dat(config)
    else:
        if not silent:
            # check to see if the file exists
            try:
                out_file = open(output)
                out_file.close()
                raise FileExistsError('Configuration file %s already exists.' % (output))
            except IOError:
                pass

        with open(output, 'w') as out_file:
            out_file.write(js2deg.dict_to_dat(config))

    return


def main():
  """
  Command-line tool for json_to_degree
  """
  # Parse commandline options
  parser = argparse.ArgumentParser(description='Convert json formatted ' +
          'config files to valid input.dat config files ' +
          'for the Hock melt model.')

  parser.add_argument('input', type=str,
          help='json equivalent of input.dat')
  parser.add_argument('-o', '--output', type=str,
          help='output filename, if unspecified output is sent to stdout')

  parser.add_argument('-s', '--silent', action="store_true",
          default=False,
          help='silently overwrite <output>, if it exists')

  args = parser.parse_args()

  json_to_dat(args.input, args.output, args.silent)


if __name__=="__main__":
  main()
